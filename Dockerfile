# ============================================================================
# ЭТАП 1: СБОРКА (BUILD)
# Компилирует Go-код в исполняемый файл
# ============================================================================

# Используем официальный образ Go для сборки (минимальный Alpine Linux)
# AS builder — именуем этот этап, чтобы потом обратиться к нему
FROM golang:1.26-alpine AS builder

# Устанавливаем рабочую директорию внутри контейнера
WORKDIR /app

# Копируем файлы зависимостей (go.mod и go.sum) — нужно для загрузки библиотек
COPY go.mod go.sum ./

# Скачиваем Go-библиотеки, указанные в go.mod
RUN go mod download

# Копируем все Go-файлы проекта в контейнер
COPY *.go ./

# Компилируем программу:
# CGO_ENABLED=0 — отключаем связь с Си-библиотеками (нужно для статической сборки)
# -o /telegram-bot — сохраняем результат в файл /telegram-bot
# Точка в конце указывает текущую директорию как пакет для сборки
RUN CGO_ENABLED=0 go build -o /telegram-bot .

# ============================================================================
# ЭТАП 2: ФИНАЛЬНЫЙ ОБРАЗ
# Создаём минимальный образ с ботом и всеми нужными утилитами
# ============================================================================

# Начинаем с чистого Alpine Linux (очень маленький дистрибутив Linux)
FROM alpine:3.21

# Устанавливаем необходимые пакеты:
#   --no-cache    Не сохранять кэш пакетов (уменьшает размер образа)
#   ca-certificates  SSL-сертификаты для HTTPS-соединений
#   ffmpeg        Утилита для обработки видео (нужна yt-dlp для объединения видео+аудио)
#   python3       Язык Python (yt-dlp написан на Python)
#   py3-pip       Менеджер пакетов Python (pip)
RUN apk add --no-cache ca-certificates ffmpeg python3 py3-pip && \
    # Устанавливаем yt-dlp — основную утилиту для скачивания видео
    # --break-system-packages — разрешаем установку в системный Python (нужно в Alpine 3.21+)
    # -U — обновить, если уже установлен
    pip3 install --break-system-packages -U yt-dlp && \
    # Проверяем версию yt-dlp (выводим для отладки)
    yt-dlp --version

# Копируем скомпилированный бинарный файл бота из этапа сборки (builder)
# В итоговом образе будет только /telegram-bot, исходный код не нужен
COPY --from=builder /telegram-bot /telegram-bot

# pip устанавливает yt-dlp в /usr/bin/yt-dlp — бот автоматически найдёт его (он в PATH)
# Поэтому переменную YT_DLP_BIN задавать не нужно

# Токен бота передаётся при запуске контейнера:
#   - через переменную окружения: -e TELEGRAM_BOT_TOKEN=...
#   - или через файл: --env-file .env
# ENTRYPOINT определяет команду, которая запустится при старте контейнера
ENTRYPOINT ["/telegram-bot"]
