// –ü–∞–∫–µ—Ç main ‚Äî —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –≤ –ø—Ä–æ–≥—Ä–∞–º–º—É.
// –≠—Ç–æ Telegram-–±–æ—Ç –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –≤–∏–¥–µ–æ —Å —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Å–∞–π—Ç–æ–≤ (YouTube, VK, Instagram, TikTok –∏ –¥—Ä.)
package main

// –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –Ω—É–∂–Ω—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏:
// - bufio: —á—Ç–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ –ø–æ—Å—Ç—Ä–æ—á–Ω–æ
// - fmt: —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç—Ä–æ–∫ (–∞–Ω–∞–ª–æ–≥ printf)
// - log: –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ (–≤—ã–≤–æ–¥ –≤ –∫–æ–Ω—Å–æ–ª—å)
// - os: —Ä–∞–±–æ—Ç–∞ —Å —Ñ–∞–π–ª–∞–º–∏ –∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –æ–∫—Ä—É–∂–µ–Ω–∏—è
// - os/exec: –∑–∞–ø—É—Å–∫ –≤–Ω–µ—à–Ω–∏—Ö –∫–æ–º–∞–Ω–¥ (yt-dlp)
// - path/filepath: —Ä–∞–±–æ—Ç–∞ —Å –ø—É—Ç—è–º–∏ –∫ —Ñ–∞–π–ª–∞–º
// - regexp: —Ä–∞–±–æ—Ç–∞ —Å —Ä–µ–≥—É–ª—è—Ä–Ω—ã–º–∏ –≤—ã—Ä–∞–∂–µ–Ω–∏—è–º–∏ (–ø–æ–∏—Å–∫ URL –≤ —Ç–µ–∫—Å—Ç–µ)
// - strings: —Ä–∞–±–æ—Ç–∞ —Å–æ —Å—Ç—Ä–æ–∫–∞–º–∏
// - time: —Ä–∞–±–æ—Ç–∞ —Å–æ –≤—Ä–µ–º–µ–Ω–µ–º (—Ç–∞–π–º–µ—Ä—ã, –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å)
// - telegram: –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Telegram Bot API
import (
	"bufio"
	"fmt"
	"log"
	"os"
	"os/exec"
	"path/filepath"
	"regexp"
	"strings"
	"time"

	telegram "github.com/go-telegram-bot-api/telegram-bot-api/v5"
)

// ============================================================================
// –ö–û–ù–°–¢–ê–ù–¢–´ –ò –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï
// ============================================================================

// –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ –≤ –º–µ–≥–∞–±–∞–π—Ç–∞—Ö, –∫–æ—Ç–æ—Ä—ã–π Telegram –ø–æ–∑–≤–æ–ª—è–µ—Ç –æ—Ç–ø—Ä–∞–≤–∏—Ç—å.
// Telegram –∏–º–µ–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –≤ 50 –ú–ë, –ø–æ—ç—Ç–æ–º—É –º—ã –∑–∞—Ä–∞–Ω–µ–µ –Ω–µ —Å–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª—ã –±–æ–ª—å—à–µ —ç—Ç–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞.
const maxFileSizeMB = 50

// –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–µ –≤ Telegram.
// Telegram –ø–æ–∑–≤–æ–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –¥–æ 4096 —Å–∏–º–≤–æ–ª–æ–≤, –æ—Å—Ç–∞–≤–ª—è–µ–º –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–ø–∞—Å.
const maxErrorMsgLen = 3500

// –†–µ–≥—É–ª—è—Ä–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ (—à–∞–±–ª–æ–Ω) –¥–ª—è –ø–æ–∏—Å–∫–∞ URL –≤ —Ç–µ–∫—Å—Ç–µ.
// –ò—â–µ—Ç —Ç–µ–∫—Å—Ç, –Ω–∞—á–∏–Ω–∞—é—â–∏–π—Å—è —Å "http://" –∏–ª–∏ "https://" –¥–æ –ø–µ—Ä–≤–æ–≥–æ –ø—Ä–æ–±–µ–ª–∞ –∏–ª–∏ –∫–æ–Ω—Ü–∞ —Å—Ç—Ä–æ–∫–∏.
// –ü—Ä–∏–º–µ—Ä: –Ω–∞–π–¥—ë—Ç "https://youtube.com/watch?v=abc" –≤–Ω—É—Ç—Ä–∏ –ª—é–±–æ–≥–æ —Ç–µ–∫—Å—Ç–∞.
var urlRegex = regexp.MustCompile(`https?://[^\s]+`)

// –í—Ä–µ–º—è –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞.
// –ù—É–∂–Ω–æ –¥–ª—è –∫–æ–º–∞–Ω–¥—ã /uptime, —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é, —Å–∫–æ–ª—å–∫–æ –≤—Ä–µ–º–µ–Ω–∏ –±–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç.
var startTime time.Time

// videoDuration —Ö—Ä–∞–Ω–∏—Ç –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–∫–∞—á–∞–Ω–Ω–æ–≥–æ –≤–∏–¥–µ–æ
// –ù—É–∂–Ω–æ, —á—Ç–æ–±—ã –ø–µ—Ä–µ–¥–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ downloadVideo –≤ handleVideoURL
var videoDuration time.Duration

// ============================================================================
// –§–£–ù–ö–¶–ò–ò –î–õ–Ø –†–ê–ë–û–¢–´ –° –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–ï–ô
// ============================================================================

// loadTokenFromEnvFile —á–∏—Ç–∞–µ—Ç —Ç–æ–∫–µ–Ω –±–æ—Ç–∞ –∏–∑ —Ñ–∞–π–ª–∞ .env
// –§–∞–π–ª .env ‚Äî —ç—Ç–æ —Ç–µ–∫—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª, –≥–¥–µ –∫–∞–∂–¥–∞—è —Å—Ç—Ä–æ–∫–∞ –∏–º–µ–µ—Ç —Ñ–æ—Ä–º–∞—Ç: –ö–õ–Æ–ß=–ó–ù–ê–ß–ï–ù–ò–ï
// –ü—Ä–∏–º–µ—Ä —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ .env:
//
//	TELEGRAM_BOT_TOKEN=1234567890:ABCdefGHIjklMNOpqrsTUVwxyz
//
// –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–æ–∫–µ–Ω –±–æ—Ç–∞ –∏–ª–∏ –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É, –µ—Å–ª–∏ —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω/–Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω.
func loadTokenFromEnvFile() string {
	// –û—Ç–∫—Ä—ã–≤–∞–µ–º —Ñ–∞–π–ª .env –¥–ª—è —á—Ç–µ–Ω–∏—è
	f, err := os.Open(".env")
	if err != nil {
		// –§–∞–π–ª–∞ –Ω–µ—Ç ‚Äî —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ, –ø–æ–ø—Ä–æ–±—É–µ–º –¥—Ä—É–≥–æ–π —Å–ø–æ—Å–æ–±
		return ""
	}
	// defer –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ —Ñ–∞–π–ª –∑–∞–∫—Ä–æ–µ—Ç—Å—è –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ –∏–∑ —Ñ—É–Ω–∫—Ü–∏–∏ (–¥–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ)
	defer f.Close()

	// –°–æ–∑–¥–∞—ë–º —Å–∫–∞–Ω–µ—Ä –¥–ª—è –ø–æ—Å—Ç—Ä–æ—á–Ω–æ–≥–æ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞
	sc := bufio.NewScanner(f)

	// –ß–∏—Ç–∞–µ–º —Ñ–∞–π–ª –ø–æ—Å—Ç—Ä–æ—á–Ω–æ
	for sc.Scan() {
		line := strings.TrimSpace(sc.Text()) // –£–±–∏—Ä–∞–µ–º –ø—Ä–æ–±–µ–ª—ã –≤ –Ω–∞—á–∞–ª–µ –∏ –∫–æ–Ω—Ü–µ —Å—Ç—Ä–æ–∫–∏

		// –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ (–Ω–∞—á–∏–Ω–∞—é—â–∏–µ—Å—è —Å #)
		if line == "" || strings.HasPrefix(line, "#") {
			continue
		}

		// –ò—â–µ–º –∑–Ω–∞–∫ "=" ‚Äî —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å –º–µ–∂–¥—É –∫–ª—é—á–æ–º –∏ –∑–Ω–∞—á–µ–Ω–∏–µ–º
		idx := strings.Index(line, "=")
		if idx <= 0 {
			continue // –ù–µ—Ç "=" –∏–ª–∏ "=" –≤ –Ω–∞—á–∞–ª–µ —Å—Ç—Ä–æ–∫–∏ ‚Äî –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Å—Ç—Ä–æ–∫–∞
		}

		// –ò–∑–≤–ª–µ–∫–∞–µ–º –∫–ª—é—á (—á–∞—Å—Ç—å –¥–æ "=") –∏ –∑–Ω–∞—á–µ–Ω–∏–µ (—á–∞—Å—Ç—å –ø–æ—Å–ª–µ "=")
		key := strings.TrimSpace(line[:idx])
		if key != "TELEGRAM_BOT_TOKEN" {
			continue // –≠—Ç–æ –Ω–µ —Ç–æ–∫–µ–Ω –±–æ—Ç–∞, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
		}

		// –ü–æ–ª—É—á–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –∏ —É–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –∫–∞–≤—ã—á–∫–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å)
		val := strings.TrimSpace(line[idx+1:])
		val = strings.Trim(val, `"'`) // –£–±–∏—Ä–∞–µ—Ç –¥–≤–æ–π–Ω—ã–µ –∏ –æ–¥–∏–Ω–∞—Ä–Ω—ã–µ –∫–∞–≤—ã—á–∫–∏ –ø–æ –∫—Ä–∞—è–º

		return val // –ù–∞—à–ª–∏ —Ç–æ–∫–µ–Ω, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –µ–≥–æ
	}

	// –¢–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Ñ–∞–π–ª–µ
	return ""
}

// ============================================================================
// –ì–õ–ê–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø ‚Äî —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –≤ –ø—Ä–æ–≥—Ä–∞–º–º—É
// ============================================================================

func main() {
	// –®–∞–≥ 1: –ü–æ–ª—É—á–∞–µ–º —Ç–æ–∫–µ–Ω –±–æ—Ç–∞
	// –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è (–¥–ª—è Docker/—Å–µ—Ä–≤–µ—Ä–∞)
	token := os.Getenv("TELEGRAM_BOT_TOKEN")

	// –ï—Å–ª–∏ –Ω–µ—Ç –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è ‚Äî –ø—Ä–æ–±—É–µ–º –ø—Ä–æ—á–∏—Ç–∞—Ç—å –∏–∑ —Ñ–∞–π–ª–∞ .env
	if token == "" {
		token = loadTokenFromEnvFile()
	}

	// –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω —Ç–∞–∫ –∏ –Ω–µ –ø–æ–ª—É—á–∏–ª–∏ ‚Äî –≤—ã—Ö–æ–¥–∏–º —Å –æ—à–∏–±–∫–æ–π
	if token == "" {
		log.Fatal("–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ TELEGRAM_BOT_TOKEN –≤ —Ñ–∞–π–ª–µ .env –∏–ª–∏ –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è")
	}

	// –®–∞–≥ 2: –°–æ–∑–¥–∞—ë–º –æ–±—ä–µ–∫—Ç –±–æ—Ç–∞ —á–µ—Ä–µ–∑ Telegram Bot API
	bot, err := telegram.NewBotAPI(token)
	if err != nil {
		// –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ Telegram ‚Äî –≤—ã—Ö–æ–¥–∏–º —Å –æ—à–∏–±–∫–æ–π
		log.Fatalf("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –±–æ—Ç–∞: %v", err)
	}

	// –í–∫–ª—é—á–∞–µ–º —Ä–µ–∂–∏–º –æ—Ç–ª–∞–¥–∫–∏ (–≤—ã–≤–æ–¥–∏—Ç –≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã –∫ Telegram –≤ –ª–æ–≥)
	bot.Debug = true

	// –ó–∞–ø–æ–º–∏–Ω–∞–µ–º –≤—Ä–µ–º—è –∑–∞–ø—É—Å–∫–∞ –¥–ª—è –∫–æ–º–∞–Ω–¥—ã /uptime
	startTime = time.Now()

	// –í—ã–≤–æ–¥–∏–º –≤ –∫–æ–Ω—Å–æ–ª—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞–ø—É—Å–∫–µ (–ª–æ–≥–∏–Ω –±–æ—Ç–∞)
	log.Printf("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω: @%s", bot.Self.UserName)

	// –®–∞–≥ 3: –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ø–æ–ª—É—á–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π (—Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)
	// NewUpdate(0) ‚Äî –ø–æ–ª—É—á–∞—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å —Å–∞–º–æ–≥–æ –Ω–∞—á–∞–ª–∞ (–∏–ª–∏ —Å –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–≥–æ)
	// Timeout = 60 —Å–µ–∫—É–Ω–¥ ‚Äî –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç Telegram
	u := telegram.NewUpdate(0)
	u.Timeout = 60

	// –ö–∞–Ω–∞–ª, –∫—É–¥–∞ Telegram –±—É–¥–µ—Ç –ø—Ä–∏—Å—ã–ª–∞—Ç—å –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
	updates := bot.GetUpdatesChan(u)

	// –®–∞–≥ 4: –ë–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ü–∏–∫–ª –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤—Ö–æ–¥—è—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
	// for update := range updates ‚Äî —ç—Ç–æ –∞–Ω–∞–ª–æ–≥ while(true), –Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –∫–∞–Ω–∞–ª–∞—Ö Go
	for update := range updates {
		// update.Message –º–æ–∂–µ—Ç –±—ã—Ç—å nil, –µ—Å–ª–∏ –ø—Ä–∏—à–ª–æ –Ω–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)
		if update.Message == nil {
			continue // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —ç—Ç–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
		}

		// –ü–æ–ª—É—á–∞–µ–º ID —á–∞—Ç–∞ (–∫—É–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –æ—Ç–≤–µ—Ç) –∏ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
		chatID := update.Message.Chat.ID
		text := strings.TrimSpace(update.Message.Text) // –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã

		// –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø—É—Å—Ç–æ–µ ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
		if text == "" {
			continue
		}

		// –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏ —Å—Å—ã–ª–∫–∞ –Ω–∞ –≤–∏–¥–µ–æ
		if url := extractFirstURL(text); url != "" {
			// –ó–∞–ø—É—Å–∫–∞–µ–º —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ –≤–∏–¥–µ–æ –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ (go handleVideoURL)
			// –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –±–æ—Ç—É –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –¥—Ä—É–≥–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è, –ø–æ–∫–∞ –∫–∞—á–∞–µ—Ç—Å—è –≤–∏–¥–µ–æ
			go handleVideoURL(bot, chatID, url)
			continue // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é
		}

		// –ï—Å–ª–∏ —Å—Å—ã–ª–æ–∫ –Ω–µ—Ç ‚Äî –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∫ –∫–æ–º–∞–Ω–¥—É –±–æ—Ç–∞
		msg := telegram.NewMessage(chatID, "") // –°–æ–∑–¥–∞—ë–º –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –æ—Ç–≤–µ—Ç–∞

		// –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∫–∞–∫—É—é –∫–æ–º–∞–Ω–¥—É –æ—Ç–ø—Ä–∞–≤–∏–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
		switch text {
		case "/start":
			// –ö–æ–º–∞–Ω–¥–∞ /start ‚Äî –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –∏ –∫—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π
			msg.Text = "–ü—Ä–∏–≤–µ—Ç! –Ø —É–º–µ—é —Å–∫–∞—á–∏–≤–∞—Ç—å –≤–∏–¥–µ–æ. –û—Ç–ø—Ä–∞–≤—å —Å—Å—ã–ª–∫—É –Ω–∞ YouTube, VK, Instagram, TikTok –∏–ª–∏ –¥—Ä—É–≥–æ–π —Å–∞–π—Ç ‚Äî –ø—Ä–∏—à–ª—é –≤–∏–¥–µ–æ.\n\n/help ‚Äî —Å–ø—Ä–∞–≤–∫–∞\n/uptime ‚Äî –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã –±–æ—Ç–∞"

		case "/help":
			// –ö–æ–º–∞–Ω–¥–∞ /help ‚Äî –ø–æ–¥—Ä–æ–±–Ω–∞—è —Å–ø—Ä–∞–≤–∫–∞ –ø–æ –∫–æ–º–∞–Ω–¥–∞–º
			msg.Text = "–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:\n/start ‚Äî –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ\n/help ‚Äî —ç—Ç–∞ —Å–ø—Ä–∞–≤–∫–∞\n/hello ‚Äî –ø–æ–∑–¥–æ—Ä–æ–≤–∞—Ç—å—Å—è\n/uptime ‚Äî –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã –±–æ—Ç–∞\n\n–ò–ª–∏ –æ—Ç–ø—Ä–∞–≤—å —Å—Å—ã–ª–∫—É –Ω–∞ –≤–∏–¥–µ–æ ‚Äî —Å–∫–∞—á–∞—é –∏ –ø—Ä–∏—à–ª—é —Ñ–∞–π–ª."

		case "/uptime":
			// –ö–æ–º–∞–Ω–¥–∞ /uptime ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, —Å–∫–æ–ª—å–∫–æ –≤—Ä–µ–º–µ–Ω–∏ –±–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç
			msg.Text = formatUptime(time.Since(startTime))

		case "/hello":
			// –ö–æ–º–∞–Ω–¥–∞ /hello ‚Äî –ø—Ä–æ—Å—Ç–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –ø–æ –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
			msg.Text = "–ü—Ä–∏–≤–µ—Ç, " + update.Message.From.FirstName + "!"

		default:
			// –ï—Å–ª–∏ –∫–æ–º–∞–Ω–¥–∞ –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–∞ ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É
			msg.Text = "–û—Ç–ø—Ä–∞–≤—å —Å—Å—ã–ª–∫—É –Ω–∞ –≤–∏–¥–µ–æ (YouTube, VK, Instagram, TikTok –∏ –¥—Ä.) ‚Äî —è —Å–∫–∞—á–∞—é –∏ –ø—Ä–∏—à–ª—é —Ñ–∞–π–ª. –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π /help."
		}

		// –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
		if _, err := bot.Send(msg); err != nil {
			// –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å ‚Äî –ø–∏—à–µ–º –≤ –ª–æ–≥ –æ—à–∏–±–∫—É
			log.Printf("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: %v", err)
		}
	}
}

// ============================================================================
// –§–£–ù–ö–¶–ò–ò –î–õ–Ø –û–ë–†–ê–ë–û–¢–ö–ò –ö–û–ú–ê–ù–î
// ============================================================================

// formatUptime –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã –±–æ—Ç–∞ –≤ —á–∏—Ç–∞–µ–º—ã–π –≤–∏–¥
// –ü—Ä–∏–Ω–∏–º–∞–µ—Ç Duration (–≤—Ä–µ–º—è –≤ –Ω–∞–Ω–æ—Å–µ–∫—É–Ω–¥–∞—Ö), –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç—Ä–æ–∫—É –≤–∏–¥–∞ "1—á 30–º 45—Å"
func formatUptime(d time.Duration) string {
	// –û–∫—Ä—É–≥–ª—è–µ–º –¥–æ —Å–µ–∫—É–Ω–¥ (—É–±–∏—Ä–∞–µ–º –º–∏–∫—Ä–æ—Å–µ–∫—É–Ω–¥—ã)
	d = d.Round(time.Second)

	// –í—ã—á–∏—Å–ª—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–∞—Å–æ–≤, –º–∏–Ω—É—Ç –∏ —Å–µ–∫—É–Ω–¥
	h := d / time.Hour   // –°–∫–æ–ª—å–∫–æ —Ü–µ–ª—ã—Ö —á–∞—Å–æ–≤
	d -= h * time.Hour   // –í—ã—á–∏—Ç–∞–µ–º —á–∞—Å—ã –∏–∑ –æ–±—â–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
	m := d / time.Minute // –°–∫–æ–ª—å–∫–æ —Ü–µ–ª—ã—Ö –º–∏–Ω—É—Ç –∏–∑ –æ—Å—Ç–∞–≤—à–µ–≥–æ—Å—è –≤—Ä–µ–º–µ–Ω–∏
	d -= m * time.Minute // –í—ã—á–∏—Ç–∞–µ–º –º–∏–Ω—É—Ç—ã
	s := d / time.Second // –°–∫–æ–ª—å–∫–æ —Ü–µ–ª—ã—Ö —Å–µ–∫—É–Ω–¥ –æ—Å—Ç–∞–ª–æ—Å—å

	// –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫—É –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–æ–≥–æ, —Å–∫–æ–ª—å–∫–æ –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä–æ—à–ª–æ
	if h > 0 {
		// –ï—Å–ª–∏ –µ—Å—Ç—å —á–∞—Å—ã: "1—á 30–º 45—Å"
		return fmt.Sprintf("–ë–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç: %d—á %d–º %d—Å", h, m, s)
	}
	if m > 0 {
		// –ï—Å–ª–∏ –µ—Å—Ç—å –º–∏–Ω—É—Ç—ã: "30–º 45—Å"
		return fmt.Sprintf("–ë–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç: %d–º %d—Å", m, s)
	}
	// –ï—Å–ª–∏ —Ç–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥—ã: "45—Å"
	return fmt.Sprintf("–ë–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç: %d—Å", s)
}

// extractFirstURL –∏—â–µ—Ç –ø–µ—Ä–≤—É—é —Å—Å—ã–ª–∫—É (URL) –≤ —Ç–µ–∫—Å—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏—è
// –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–∞–π–¥–µ–Ω–Ω—ã–π URL –∏–ª–∏ –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É, –µ—Å–ª–∏ —Å—Å—ã–ª–æ–∫ –Ω–µ—Ç
func extractFirstURL(text string) string {
	// –ò—â–µ–º URL —Å –ø–æ–º–æ—â—å—é —Ä–µ–≥—É–ª—è—Ä–Ω–æ–≥–æ –≤—ã—Ä–∞–∂–µ–Ω–∏—è (urlRegex)
	// FindString –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–µ—Ä–≤–æ–µ –Ω–∞–π–¥–µ–Ω–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
	raw := urlRegex.FindString(text)

	// –ò–Ω–æ–≥–¥–∞ –≤ –∫–æ–Ω—Ü–µ URL –º–æ–≥—É—Ç —Å–ª—É—á–∞–π–Ω–æ –æ–∫–∞–∑–∞—Ç—å—Å—è –∑–Ω–∞–∫–∏ –ø—Ä–µ–ø–∏–Ω–∞–Ω–∏—è
	// (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–ü–æ—Å–º–æ—Ç—Ä–∏ —ç—Ç–æ –≤–∏–¥–µ–æ: https://youtube.com/watch?v=abc!")
	// –£–±–∏—Ä–∞–µ–º –∏—Ö —Å –ø–æ–º–æ—â—å—é TrimRight
	raw = strings.TrimRight(raw, ".,;:!?)")

	return raw
}

// ============================================================================
// –§–£–ù–ö–¶–ò–ò –î–õ–Ø –†–ê–ë–û–¢–´ –° –í–ò–î–ï–û
// ============================================================================

// VideoInfo —Ö—Ä–∞–Ω–∏—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–∫–∞—á–∞–Ω–Ω–æ–º –≤–∏–¥–µ–æ
type VideoInfo struct {
	filename     string        // –ò–º—è —Ñ–∞–π–ª–∞
	size         int64         // –†–∞–∑–º–µ—Ä –≤ –±–∞–π—Ç–∞—Ö
	duration     time.Duration // –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
	downloadTime time.Duration // –í—Ä–µ–º—è –Ω–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ
}

// handleVideoURL –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å—Å—ã–ª–∫—É –Ω–∞ –≤–∏–¥–µ–æ: —Å–∫–∞—á–∏–≤–∞–µ—Ç –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
// –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–π –≥–æ—Ä—É—Ç–∏–Ω–µ (go handleVideoURL), —á—Ç–æ–±—ã –Ω–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –±–æ—Ç–∞
//
// –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
//   - bot: –æ–±—ä–µ–∫—Ç –±–æ—Ç–∞ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
//   - chatID: ID —á–∞—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–∫—É–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –æ—Ç–≤–µ—Ç)
//   - url: —Å—Å—ã–ª–∫–∞ –Ω–∞ –≤–∏–¥–µ–æ, –∫–æ—Ç–æ—Ä—É—é –Ω—É–∂–Ω–æ —Å–∫–∞—á–∞—Ç—å
func handleVideoURL(bot *telegram.BotAPI, chatID int64, url string) {
	// –°–±—Ä–∞—Å—ã–≤–∞–µ–º –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –≤–∏–¥–µ–æ
	videoDuration = 0

	// –ó–∞—Å–µ–∫–∞–µ–º –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
	startTime := time.Now()

	// –®–∞–≥ 1: –û—Ç–ø—Ä–∞–≤–ª—è–µ–º "—Å—Ç–∞—Ç—É—Å–Ω–æ–µ" —Å–æ–æ–±—â–µ–Ω–∏–µ, —á—Ç–æ–±—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–Ω–∞–ª, —á—Ç–æ –∏–¥—ë—Ç —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ
	statusMsg, _ := bot.Send(telegram.NewMessage(chatID, "–°–∫–∞—á–∏–≤–∞—é –≤–∏–¥–µ–æ‚Ä¶"))

	// –®–∞–≥ 2: –°–∫–∞—á–∏–≤–∞–µ–º –≤–∏–¥–µ–æ —Å –ø–æ–º–æ—â—å—é yt-dlp
	// –§—É–Ω–∫—Ü–∏—è –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—É—Ç—å –∫ —Å–∫–∞—á–∞–Ω–Ω–æ–º—É —Ñ–∞–π–ª—É –∏–ª–∏ –æ—à–∏–±–∫—É
	filePath, err := downloadVideo(url)

	// –í—ã—á–∏—Å–ª—è–µ–º –≤—Ä–µ–º—è, –∑–∞—Ç—Ä–∞—á–µ–Ω–Ω–æ–µ –Ω–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ
	downloadDuration := time.Since(startTime)

	// –®–∞–≥ 3: –ï—Å–ª–∏ –ø—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞
	if err != nil {
		log.Printf("–û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è %s: %v", url, err)

		// –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
		errMsg := "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–∞—á–∞—Ç—å –≤–∏–¥–µ–æ: " + err.Error() + "\n\n–ü—Ä–æ–≤–µ—Ä—å —Å—Å—ã–ª–∫—É –∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Ä–æ–ª–∏–∫–∞ (–ø—Ä–∏–≤–∞—Ç–Ω–æ–µ, —Ä–µ–≥–∏–æ–Ω –∏ —Ç.–¥.)."
		bot.Send(telegram.NewMessage(chatID, errMsg))

		// –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ "–°–∫–∞—á–∏–≤–∞—é –≤–∏–¥–µ–æ‚Ä¶"
		bot.Request(telegram.NewDeleteMessage(chatID, statusMsg.MessageID))
		return // –í—ã—Ö–æ–¥–∏–º –∏–∑ —Ñ—É–Ω–∫—Ü–∏–∏
	}

	// defer –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –≤—Ä–µ–º–µ–Ω–Ω–∞—è –ø–∞–ø–∫–∞ —Å –≤–∏–¥–µ–æ —É–¥–∞–ª–∏—Ç—Å—è –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–∏
	// –î–∞–∂–µ –µ—Å–ª–∏ –ø—Ä–æ–∏–∑–æ–π–¥—ë—Ç –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ, –ø–∞–ø–∫–∞ –≤—Å—ë —Ä–∞–≤–Ω–æ –æ—á–∏—Å—Ç–∏—Ç—Å—è
	defer os.RemoveAll(filepath.Dir(filePath))

	// –®–∞–≥ 4: –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ "–°–∫–∞—á–∏–≤–∞—é –≤–∏–¥–µ–æ‚Ä¶"
	bot.Request(telegram.NewDeleteMessage(chatID, statusMsg.MessageID))

	// –®–∞–≥ 5: –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞
	// Telegram –Ω–µ –ø–æ–∑–≤–æ–ª—è–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Ñ–∞–π–ª—ã –±–æ–ª—å—à–µ 50 –ú–ë
	info, _ := os.Stat(filePath)                              // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ñ–∞–π–ª–µ (—Ä–∞–∑–º–µ—Ä, –¥–∞—Ç–∞ –∏ —Ç.–¥.)
	if info != nil && info.Size() > maxFileSizeMB*1024*1024 { // 50 –ú–ë –≤ –±–∞–π—Ç–∞—Ö
		// –§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π ‚Äî —Å–æ–æ–±—â–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
		bot.Send(telegram.NewMessage(chatID, "–§–∞–π–ª –ø–æ–ª—É—á–∏–ª—Å—è –±–æ–ª—å—à–µ 50 –ú–ë ‚Äî Telegram –Ω–µ –ø—Ä–∏–º–µ—Ç —Ç–∞–∫–æ–π —Ä–∞–∑–º–µ—Ä. –ü–æ–ø—Ä–æ–±—É–π –¥—Ä—É–≥—É—é —Å—Å—ã–ª–∫—É –∏–ª–∏ –∫–∞—á–µ—Å—Ç–≤–æ."))
		return
	}

	// –®–∞–≥ 6: –ü–æ–ª—É—á–∞–µ–º –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤–∏–¥–µ–æ
	// –ú—ã —É–∂–µ –ø–æ–ª—É—á–∏–ª–∏ –µ—ë –ø—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏ —á–µ—Ä–µ–∑ yt-dlp (–∏–∑ JSON-–º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö)
	duration := videoDuration

	// –ï—Å–ª–∏ –ø–æ –∫–∞–∫–æ–π-—Ç–æ –ø—Ä–∏—á–∏–Ω–µ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –Ω–µ –ø–æ–ª—É—á–µ–Ω–∞ ‚Äî –ø—Ä–æ–±—É–µ–º —á–µ—Ä–µ–∑ ffprobe
	if duration == 0 {
		duration = getVideoDuration(filePath)
	}

	// –§–æ—Ä–º–∏—Ä—É–µ–º –ø–æ–¥–ø–∏—Å—å –¥–ª—è —Ñ–∞–π–ª–∞
	filename := filepath.Base(filePath)
	sizeStr := formatFileSize(info.Size())
	durationStr := formatDuration(duration)
	downloadTimeStr := formatDuration(downloadDuration)

	caption := fmt.Sprintf("üìπ %s\n‚è± –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: %s\nüíæ –†–∞–∑–º–µ—Ä: %s\n‚ö° –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ –∑–∞: %s",
		filename, durationStr, sizeStr, downloadTimeStr)

	// –®–∞–≥ 7: –ü—ã—Ç–∞–µ–º—Å—è –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤–∏–¥–µ–æ —Å –ø–æ–¥–ø–∏—Å—å—é
	// –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º –∫–∞–∫ –≤–∏–¥–µ–æ (Telegram –ø–æ–Ω–∏–º–∞–µ—Ç, —á—Ç–æ —ç—Ç–æ –≤–∏–¥–µ–æ, –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–ª–µ–µ—Ä)
	video := telegram.NewVideo(chatID, telegram.FilePath(filePath))
	video.Caption = caption // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–¥–ø–∏—Å—å
	if _, err := bot.Send(video); err != nil {
		// –ï—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–∞–∫ –≤–∏–¥–µ–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –Ω–µ–æ–±—ã—á–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç),
		// –ø—Ä–æ–±—É–µ–º –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–∞–∫ –¥–æ–∫—É–º–µ–Ω—Ç (—Ñ–∞–π–ª)
		doc := telegram.NewDocument(chatID, telegram.FilePath(filePath))
		doc.Caption = caption // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–¥–ø–∏—Å—å
		if _, err2 := bot.Send(doc); err2 != nil {
			// –ï—Å–ª–∏ –∏ –∫–∞–∫ –¥–æ–∫—É–º–µ–Ω—Ç –Ω–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å ‚Äî —Å–æ–æ–±—â–∞–µ–º –æ–± –æ—à–∏–±–∫–µ
			log.Printf("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–∞–π–ª–∞: %v", err)
			bot.Send(telegram.NewMessage(chatID, "–°–∫–∞—á–∞–ª —Ñ–∞–π–ª, –Ω–æ –Ω–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å: "+err.Error()))
		}
	}
	// –ï—Å–ª–∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ —É—Å–ø–µ—à–Ω–∞ ‚Äî –≤—Å—ë –≥–æ—Ç–æ–≤–æ, —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–≤–µ—Ä—à–∏—Ç—Å—è,
	// –∏ defer —É–¥–∞–ª–∏—Ç –≤—Ä–µ–º–µ–Ω–Ω—É—é –ø–∞–ø–∫—É —Å –≤–∏–¥–µ–æ
}

// formatFileSize –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ –≤ —á–∏—Ç–∞–µ–º—ã–π –≤–∏–¥
// –ù–∞–ø—Ä–∏–º–µ—Ä: 1024 -> "1 KB", 1024*1024 -> "1 MB"
func formatFileSize(bytes int64) string {
	const unit = 1024
	if bytes < unit {
		return fmt.Sprintf("%d B", bytes)
	}
	size := float64(bytes)
	units := []string{"B", "KB", "MB", "GB", "TB"} // –º–æ–∂–Ω–æ —Ä–∞—Å—à–∏—Ä–∏—Ç—å
	exp := 0
	for size >= unit && exp < len(units)-1 {
		size /= unit
		exp++
	}
	return fmt.Sprintf("%.1f %s", size, units[exp])
}

// formatDuration –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤ —á–∏—Ç–∞–µ–º—ã–π –≤–∏–¥
// –ù–∞–ø—Ä–∏–º–µ—Ä: 125 —Å–µ–∫—É–Ω–¥ -> "2:05", 3725 —Å–µ–∫—É–Ω–¥ -> "1:02:05"
func formatDuration(d time.Duration) string {
	d = d.Round(time.Second)
	h := d / time.Hour
	d -= h * time.Hour
	m := d / time.Minute
	d -= m * time.Minute
	s := d / time.Second

	if h > 0 {
		return fmt.Sprintf("%d:%02d:%02d", h, m, s)
	}
	return fmt.Sprintf("%d:%02d", m, s)
}

// getVideoDuration –ø–æ–ª—É—á–∞–µ—Ç –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤–∏–¥–µ–æ —Å –ø–æ–º–æ—â—å—é ffprobe
// ffprobe –≤—Ö–æ–¥–∏—Ç –≤ —Å–æ—Å—Ç–∞–≤ ffmpeg –∏ –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø–æ–ª—É—á–∏—Ç—å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –≤–∏–¥–µ–æ
func getVideoDuration(filePath string) time.Duration {
	// –ó–∞–ø—É—Å–∫–∞–µ–º ffprobe –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –≤–∏–¥–µ–æ
	// -v error ‚Äî –≤—ã–≤–æ–¥–∏—Ç—å —Ç–æ–ª—å–∫–æ –æ—à–∏–±–∫–∏
	// -show_entries format=duration ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å —Ç–æ–ª—å–∫–æ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
	// -of default=noprint_wrappers=1:nokey=1 ‚Äî –≤—ã–≤–µ—Å—Ç–∏ —Ç–æ–ª—å–∫–æ —á–∏—Å–ª–æ
	cmd := exec.Command("ffprobe",
		"-v", "error",
		"-show_entries", "format=duration",
		"-of", "default=noprint_wrappers=1:nokey=1",
		filePath,
	)

	output, err := cmd.Output()
	if err != nil {
		log.Printf("–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏: %v", err)
		return 0
	}

	// –í—ã–≤–æ–¥ ffprobe ‚Äî —Å—Ç—Ä–æ–∫–∞ —Å —á–∏—Å–ª–æ–º (–Ω–∞–ø—Ä–∏–º–µ—Ä, "125.5")
	// –ü–∞—Ä—Å–∏–º –µ—ë –≤ float64
	var seconds float64
	if _, err := fmt.Sscanf(string(output), "%f", &seconds); err != nil {
		log.Printf("–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏: %v", err)
		return 0
	}

	// –í–æ–∑–≤—Ä–∞—â–∞–µ–º –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤ –≤–∏–¥–µ Duration
	return time.Duration(seconds * float64(time.Second))
}

// downloadVideo —Å–∫–∞—á–∏–≤–∞–µ—Ç –≤–∏–¥–µ–æ –ø–æ URL —Å –ø–æ–º–æ—â—å—é yt-dlp
// –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—É—Ç—å –∫ —Å–∫–∞—á–∞–Ω–Ω–æ–º—É —Ñ–∞–π–ª—É –∏–ª–∏ –æ—à–∏–±–∫—É, –µ—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å —Å–∫–∞—á–∞—Ç—å
func downloadVideo(url string) (string, error) {
	// –®–∞–≥ 1: –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –∫–∞–∫–æ–π –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–π —Ñ–∞–π–ª –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è yt-dlp
	// –ú–æ–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å —Å–≤–æ–π –ø—É—Ç—å —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è YT_DLP_BIN
	// –ï—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–∞ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –∫–æ–º–∞–Ω–¥—É "yt-dlp"
	ytDlp := os.Getenv("YT_DLP_BIN")
	if ytDlp == "" {
		ytDlp = "yt-dlp"
	}

	// –®–∞–≥ 2: –°–æ–∑–¥–∞—ë–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –ø–∞–ø–∫—É –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
	// MkdirTemp —Å–æ–∑–¥–∞—ë—Ç –ø–∞–ø–∫—É —Å —Å–ª—É—á–∞–π–Ω—ã–º –∏–º–µ–Ω–µ–º –≤ —Å–∏—Å—Ç–µ–º–Ω–æ–π –≤—Ä–µ–º–µ–Ω–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
	// –®–∞–±–ª–æ–Ω "tg-video-*" –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –∏–º—è –±—É–¥–µ—Ç –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å "tg-video-"
	dir, err := os.MkdirTemp("", "tg-video-*")
	if err != nil {
		return "", err // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É –∏ –æ—à–∏–±–∫—É
	}

	// –®–∞–≥ 3: –°–Ω–∞—á–∞–ª–∞ –ø–æ–ª—É—á–∞–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –≤–∏–¥–µ–æ (–∑–∞–≥–æ–ª–æ–≤–æ–∫, –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å)
	// –ò—Å–ø–æ–ª—å–∑—É–µ–º --dump-json –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –≤ JSON-—Ñ–æ—Ä–º–∞—Ç–µ
	// –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç —É–∑–Ω–∞—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ –≤–∏–¥–µ–æ –ø–µ—Ä–µ–¥ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ–º
	cmdInfo := exec.Command(ytDlp,
		"--no-playlist",
		"--dump-json",
		"--no-warnings",
		"--no-call-home",
		url,
	)
	infoOutput, err := cmdInfo.Output()
	if err != nil {
		os.RemoveAll(dir)
		return "", fmt.Errorf("–Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤–∏–¥–µ–æ: %v", err)
	}

	// –ü–∞—Ä—Å–∏–º JSON-–æ—Ç–≤–µ—Ç
	// –ò—â–µ–º –ø–æ–ª—è "title" –∏ "duration" –≤ JSON
	jsonStr := string(infoOutput)
	title := extractJSONString(jsonStr, "title")
	duration := extractJSONFloat(jsonStr, "duration")

	// –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å title ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–ª—É—á–∞–π–Ω–æ–µ –∏–º—è
	if title == "" {
		title = "video"
	}

	// –û—á–∏—â–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –æ—Ç –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤ –¥–ª—è –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞
	// –û—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã, –¥–µ—Ñ–∏—Å—ã, –ø–æ–¥—á—ë—Ä–∫–∏–≤–∞–Ω–∏—è –∏ –ø—Ä–æ–±–µ–ª—ã
	title = sanitizeFilename(title)

	// –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤ –≥–ª–æ–±–∞–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ
	// –≠—Ç–æ –Ω—É–∂–Ω–æ, —Ç–∞–∫ –∫–∞–∫ —Ñ—É–Ω–∫—Ü–∏—è –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–æ–ª—å–∫–æ –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É
	if duration > 0 {
		videoDuration = time.Duration(duration * float64(time.Second))
	}

	// –§–æ—Ä–º–∏—Ä—É–µ–º –ø—É—Ç—å –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–∞–π–ª–∞ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –Ω–∞–∑–≤–∞–Ω–∏—è –≤–∏–¥–µ–æ
	// %(title).100s ‚Äî –æ–±—Ä–µ–∑–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–æ 100 —Å–∏–º–≤–æ–ª–æ–≤, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã—Ö –∏–º—ë–Ω
	// %(ext)s ‚Äî —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Ñ–∞–π–ª–∞
	outPath := filepath.Join(dir, "%(title).100s.%(ext)s")

	// –®–∞–≥ 4: –§–æ—Ä–º–∏—Ä—É–µ–º –∫–æ–º–∞–Ω–¥—É –¥–ª—è yt-dlp —Å –Ω—É–∂–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
	//
	// –ü–∞—Ä–∞–º–µ—Ç—Ä—ã yt-dlp:
	//   --no-playlist        –ù–µ —Å–∫–∞—á–∏–≤–∞—Ç—å –≤–µ—Å—å –ø–ª–µ–π–ª–∏—Å—Ç, —Ç–æ–ª—å–∫–æ –æ–¥–Ω–æ –≤–∏–¥–µ–æ
	//   -f best[ext=mp4]/best   –§–æ—Ä–º–∞—Ç: —Å–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º –ª—É—á—à–∏–π mp4, –∏–Ω–∞—á–µ ‚Äî –ª—É—á—à–∏–π –¥–æ—Å—Ç—É–ø–Ω—ã–π
	//   --merge-output-format mp4  –ï—Å–ª–∏ –≤–∏–¥–µ–æ –∏ –∞—É–¥–∏–æ –æ—Ç–¥–µ–ª—å–Ω–æ ‚Äî –æ–±—ä–µ–¥–∏–Ω—è–µ–º –≤ MP4
	//   --max-filesize 50M    –ù–µ —Å–∫–∞—á–∏–≤–∞—Ç—å —Ñ–∞–π–ª—ã –±–æ–ª—å—à–µ 50 –ú–ë
	//   -o outPath           –ö—É–¥–∞ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å —Ñ–∞–π–ª (—Å –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä–æ–º –¥–ª—è —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è)
	//   --no-warnings        –ù–µ –≤—ã–≤–æ–¥–∏—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –≤ –∫–æ–Ω—Å–æ–ª—å
	//   --no-call-home       –ù–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞–º yt-dlp
	//   --user-agent         –≠–º—É–ª–∏—Ä—É–µ–º –±—Ä–∞—É–∑–µ—Ä Firefox, —á—Ç–æ–±—ã —Å–∞–π—Ç—ã –Ω–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞–ª–∏ –±–æ—Ç–∞
	//   url                  –°—Å—ã–ª–∫–∞ –Ω–∞ –≤–∏–¥–µ–æ
	cmd := exec.Command(ytDlp,
		"--no-playlist",
		"-f", "best[ext=mp4]/best",
		"--merge-output-format", "mp4",
		"--max-filesize", "50M",
		"-o", outPath,
		"--no-warnings",
		"--no-call-home",
		"--user-agent", "Mozilla/5.0 (Windows NT 10.0; rv:131.0) Gecko/20100101 Firefox/131.0",
		url,
	)

	// –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞–±–æ—á—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –∫–æ–º–∞–Ω–¥—ã
	cmd.Dir = dir

	// –®–∞–≥ 5: –ó–∞–ø—É—Å–∫–∞–µ–º –∫–æ–º–∞–Ω–¥—É –∏ –∂–¥—ë–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
	// CombinedOutput –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç stdout + stderr (–≤—Å—ë, —á—Ç–æ –∫–æ–º–∞–Ω–¥–∞ –≤—ã–≤–µ–ª–∞ –≤ –∫–æ–Ω—Å–æ–ª—å)
	out, err := cmd.CombinedOutput()

	// –®–∞–≥ 6: –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ—à–∏–±–∫—É —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
	if err != nil {
		// –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –ø–∞–ø–∫—É, —Ç–∞–∫ –∫–∞–∫ –æ–Ω–∞ –±–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–Ω–∞
		os.RemoveAll(dir)

		// –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤—ã–≤–æ–¥ –∫–æ–º–∞–Ω–¥—ã –≤ —Å—Ç—Ä–æ–∫—É –∏ —É–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã
		raw := strings.TrimSpace(string(out))

		// –ü–æ–ª–Ω—ã–π –≤—ã–≤–æ–¥ –∑–∞–ø–∏—Å—ã–≤–∞–µ–º –≤ –ª–æ–≥ (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)
		log.Printf("[yt-dlp] URL=%s err=%v\n[yt-dlp] –ø–æ–ª–Ω—ã–π –≤—ã–≤–æ–¥:\n%s", url, err, raw)

		// –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
		// –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–ª–∏–Ω—É, —á—Ç–æ–±—ã –æ–Ω–æ –ø–æ–º–µ—Å—Ç–∏–ª–æ—Å—å –≤ Telegram
		msg := raw
		if len(msg) > maxErrorMsgLen {
			// –ï—Å–ª–∏ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ ‚Äî –±–µ—Ä—ë–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å–∏–º–≤–æ–ª—ã (—Ç–∞–º –æ–±—ã—á–Ω–æ —Å–∞–º–∞—è –≤–∞–∂–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è)
			msg = "...\n" + msg[len(msg)-maxErrorMsgLen:]
		}

		// –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—à–∏–±–∫—É —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
		if msg != "" {
			return "", fmt.Errorf("%v\n\n–õ–æ–≥ yt-dlp:\n%s", err, msg)
		}
		return "", err
	}

	// –®–∞–≥ 7: –ò—â–µ–º —Å–∫–∞—á–∞–Ω–Ω—ã–π —Ñ–∞–π–ª
	// yt-dlp —Å–æ–∑–¥–∞—ë—Ç —Ñ–∞–π–ª —Å —Ä–µ–∞–ª—å–Ω—ã–º –Ω–∞–∑–≤–∞–Ω–∏–µ–º –∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ–º
	entries, _ := os.ReadDir(dir) // –ß–∏—Ç–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –≤—Ä–µ–º–µ–Ω–Ω–æ–π –ø–∞–ø–∫–∏

	// –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –≤—Å–µ–º —Ñ–∞–π–ª–∞–º –≤ –ø–∞–ø–∫–µ
	for _, e := range entries {
		if !e.IsDir() { // –ï—Å–ª–∏ —ç—Ç–æ —Ñ–∞–π–ª, –∞ –Ω–µ –ø–∞–ø–∫–∞
			// –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø–æ–ª–Ω—ã–π –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É
			return filepath.Join(dir, e.Name()), nil
		}
	}

	// –ï—Å–ª–∏ —Ñ–∞–π–ª–æ–≤ –Ω–µ –Ω–∞—à–ª–æ—Å—å (—Å—Ç—Ä–∞–Ω–Ω–∞—è —Å–∏—Ç—É–∞—Ü–∏—è) ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—à–∏–±–∫—É
	os.RemoveAll(dir)
	return "", os.ErrNotExist
}

// sanitizeFilename –æ—á–∏—â–∞–µ—Ç —Å—Ç—Ä–æ–∫—É –æ—Ç –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤ –≤ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞
// –û—Å—Ç–∞–≤–ª—è–µ—Ç —Ç–æ–ª—å–∫–æ –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã: –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã, –ø—Ä–æ–±–µ–ª—ã, –¥–µ—Ñ–∏—Å—ã, –ø–æ–¥—á—ë—Ä–∫–∏–≤–∞–Ω–∏—è
func sanitizeFilename(name string) string {
	// –°–æ–∑–¥–∞—ë–º "–±–µ–ª—ã–π —Å–ø–∏—Å–æ–∫" –¥–æ–ø—É—Å—Ç–∏–º—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤
	// –ë—É–∫–≤—ã (–ª–∞—Ç–∏–Ω–∏—Ü–∞ + –∫–∏—Ä–∏–ª–ª–∏—Ü–∞), —Ü–∏—Ñ—Ä—ã, –ø—Ä–æ–±–µ–ª, –¥–µ—Ñ–∏—Å, –ø–æ–¥—á—ë—Ä–∫–∏–≤–∞–Ω–∏–µ, —Ç–æ—á–∫–∞
	allowed := func(r rune) bool {
		return (r >= 'a' && r <= 'z') ||
			(r >= 'A' && r <= 'Z') ||
			(r >= '–∞' && r <= '—è') ||
			(r >= '–ê' && r <= '–Ø') ||
			(r >= '0' && r <= '9') ||
			r == ' ' || r == '-' || r == '_' || r == '.'
	}

	// –§–∏–ª—å—Ç—Ä—É–µ–º –∫–∞–∂–¥—ã–π —Å–∏–º–≤–æ–ª
	result := strings.Map(func(r rune) rune {
		if allowed(r) {
			return r
		}
		return -1 // –£–¥–∞–ª—è–µ–º —Å–∏–º–≤–æ–ª
	}, name)

	// –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã –ø–æ –∫—Ä–∞—è–º
	result = strings.TrimSpace(result)

	// –ï—Å–ª–∏ –ø–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏ —Å—Ç—Ä–æ–∫–∞ –ø—É—Å—Ç–∞—è ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ–º "video"
	if result == "" {
		return "video"
	}

	return result
}

// extractJSONString –∏—â–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫–æ–≤–æ–≥–æ –ø–æ–ª—è –≤ JSON-–≤—ã–≤–æ–¥–µ yt-dlp
// –ü—Ä–æ—Å—Ç–æ–π –ø–∞—Ä—Å–∏–Ω–≥ –±–µ–∑ –≤–Ω–µ—à–Ω–∏—Ö –±–∏–±–ª–∏–æ—Ç–µ–∫
func extractJSONString(json, field string) string {
	// –ò—â–µ–º "field":"value" –∏–ª–∏ "field": "value"
	pattern := fmt.Sprintf(`"%s":\s*"([^"]*)"`, field)
	re := regexp.MustCompile(pattern)
	matches := re.FindStringSubmatch(json)
	if len(matches) > 1 {
		return matches[1]
	}
	return ""
}

// extractJSONFloat –∏—â–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ —á–∏—Å–ª–æ–≤–æ–≥–æ –ø–æ–ª—è (duration) –≤ JSON-–≤—ã–≤–æ–¥–µ yt-dlp
func extractJSONFloat(json, field string) float64 {
	// –ò—â–µ–º "field":123.45
	pattern := fmt.Sprintf(`"%s":\s*([0-9.]+)`, field)
	re := regexp.MustCompile(pattern)
	matches := re.FindStringSubmatch(json)
	if len(matches) > 1 {
		var val float64
		fmt.Sscanf(matches[1], "%f", &val)
		return val
	}
	return 0
}
